git:
    depth: 1

cache:
    directories:
        - $HOME/.composer

language: php

notifications:
    email: false

before_install:
    - phpenv config-rm xdebug.ini || return 0
    - composer global outdated --strict hirak/prestissimo || composer global require hirak/prestissimo

install: composer update $COMPOSER_FLAGS --no-progress --no-suggest

script: composer test

jobs:
    include:
        -   stage: Analyse
            php: '7.4'
            install:
                - composer install --no-progress --no-suggest --working-dir=./dev-tools
                - composer update --no-progress --no-suggest $COMPOSER_FLAGS
            script:
                - ./dev-tools/check_trailing_whitespaces.sh
                - composer analyse

        -   stage: Test
            php: '7.1.0'
            env: COMPOSER_FLAGS="--prefer-lowest"

        -   php: '7.1'

        -   php: '7.2'

        -   php: '7.3'

        -   php: '7.4'
            before_install:
                - phpenv config-rm xdebug.ini || return 0
                - composer global outdated --strict hirak/prestissimo || composer global require hirak/prestissimo
                - pecl install pcov
                - echo "pcov.directory = ." >> $HOME/.phpenv/versions/$TRAVIS_PHP_VERSION/etc/conf.d/pcov.ini
            install:
                - composer install --no-progress --no-suggest --working-dir=./dev-tools
                - composer require --dev php-coveralls/php-coveralls infection/infection:^0.15
            script:
                - composer test -- --coverage-xml=./build/coverage/coverage-xml --log-junit=./build/coverage/junit.xml
                - composer infection --working-dir=./dev-tools -- --coverage=../build/coverage/
            after_success: ./vendor/bin/php-coveralls
